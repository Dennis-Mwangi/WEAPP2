<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Weather App By Dennis</title>
  <meta name="theme-color" content="#0ea5e9">
  <link rel="icon" href="/icons/icon-192x192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small custom utilities */
    @layer utilities {
      .glass { background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); backdrop-filter: blur(8px); }
      .card-shadow { box-shadow: 0 8px 30px rgba(2,6,23,0.6); }
      .fade-in { animation: fadeIn .45s ease both; }
      @keyframes fadeIn { from{opacity:0; transform: translateY(6px)} to{opacity:1; transform:none} }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-sky-600 to-indigo-700 text-slate-100 antialiased">
  <div class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-8">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center text-2xl font-bold">‚òÅÔ∏è</div>
        <div>
          <h1 class="text-2xl font-extrabold">Weather App</h1>
          <p class="text-sm text-sky-100/80">Beautiful & fast weather Dashboard</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="themeToggle" class="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 transition">Toggle Theme</button>
        <div class="text-sm text-sky-100/80">Welcome To The weather App</div>
      </div>
    </header>

    <!-- Main card layout -->
    <main class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">

      <!-- Left: Auth + Quick actions -->
      <section class="col-span-1 space-y-6">
        <!-- Login card -->
        <div id="login-section" class="glass card-shadow rounded-2xl p-6 fade-in">
          <h2 class="text-xl font-semibold mb-3">üîê Welcome back</h2>
          <p class="text-sm text-sky-100/70 mb-4">Sign in to access personalized favorites & history.</p>
          <input id="login-username" class="w-full mb-3 px-4 py-2 rounded-xl bg-white/10 border border-white/5 placeholder:text-sky-50/60" placeholder="Username" autocomplete="username">
          <input id="login-password" type="password" class="w-full mb-3 px-4 py-2 rounded-xl bg-white/10 border border-white/5" placeholder="Password" autocomplete="current-password">
          <button id="login-btn" class="w-full py-2 rounded-xl bg-gradient-to-r from-sky-500 to-indigo-600 font-semibold shadow hover:scale-[1.01] transition">Sign in</button>
          <p id="login-message" class="mt-3 text-sm text-rose-300" aria-live="polite"></p>
          <div class="flex justify-between mt-4 text-sm">
            <button onclick="showRegisterModal()" class="underline">Create account</button>
            <button onclick="showForgotPasswordModal()" class="underline">Forgot?</button>
          </div>
        </div>

        <!-- Search box (compact) -->
        <div class="glass card-shadow rounded-2xl p-5 fade-in">
          <label class="block text-sm font-medium mb-2">üîé Quick Search</label>
          <div class="flex gap-2">
            <input id="cityInput" class="flex-1 px-4 py-2 rounded-xl bg-white/8 border border-white/5" placeholder="Enter city name">
            <button onclick="getWeather()" class="px-4 py-2 rounded-xl bg-indigo-500 font-semibold">Search</button>
          </div>
          <div class="mt-3 flex gap-2">
            <button onclick="geolocation()" class="flex-1 px-3 py-2 rounded-xl bg-emerald-400 text-black font-medium">Use my location</button>
            <button onclick="logout()" class="px-3 py-2 rounded-xl bg-white/10">Logout</button>
          </div>
        </div>

        <!-- Recent searches -->
        <div class="glass card-shadow rounded-2xl p-5 fade-in">
          <h3 class="font-semibold mb-3">üïí Recent</h3>
          <ul id="recentList" class="space-y-2 text-slate-100/90 text-sm"></ul>
        </div>

        <!-- Favorites -->
        <div class="glass card-shadow rounded-2xl p-5 fade-in">
          <h3 class="font-semibold mb-3">‚≠ê Favorites</h3>
          <ul id="favoritesList" class="space-y-2 text-slate-100/90 text-sm"></ul>
        </div>
      </section>

      <!-- Middle: Primary Weather Panel -->
      <section id="weather" class="col-span-2 glass card-shadow rounded-3xl p-6 min-h-[360px] flex flex-col justify-center items-center gap-4">
        <div class="text-center">
          <h2 class="text-3xl font-extrabold">Start by searching a city</h2>
          <p class="text-sky-100/80 mt-2">Get forecasts, add favorites, and enjoy smooth transitions.</p>
        </div>
        <div id="weatherPlaceholder" class="mt-6 opacity-80 text-sm text-sky-50/80">Tip: Sign in to save favorites and see recent searches persistently.</div>
      </section>

    </main>

    <!-- Footer small -->
    <footer class="mt-8 text-center text-sm text-sky-100/60">¬© 2025 Dennis Mwangi Designs ‚Äî Weather Studio</footer>
  </div>

  <!-- Register Modal -->
  <div id="register-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md glass rounded-2xl p-6 card-shadow">
      <button onclick="closeRegisterModal()" class="float-right text-white/80">&times;</button>
      <h3 class="text-xl font-bold mb-3">Create Account</h3>
      <input id="register-username" class="w-full mb-3 px-4 py-2 rounded-xl bg-white/8" placeholder="Username">
      <input id="register-password" type="password" class="w-full mb-3 px-4 py-2 rounded-xl bg-white/8" placeholder="Password">
      <button id="register-btn" onclick="register()" class="w-full py-2 rounded-xl bg-gradient-to-r from-sky-500 to-indigo-600 font-semibold">Create</button>
      <p id="register-message" class="mt-3 text-sm text-rose-300"></p>
    </div>
  </div>

  <!-- Forgot Modal -->
  <div id="forgot-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-md glass rounded-2xl p-6 card-shadow">
      <button onclick="closeForgotModal()" class="float-right text-white/80">&times;</button>
      <h3 class="text-xl font-bold mb-3">Reset Password</h3>
      <input id="forgot-username" class="w-full mb-3 px-4 py-2 rounded-xl bg-white/8" placeholder="Username">
      <input id="forgot-new-password" type="password" class="w-full mb-3 px-4 py-2 rounded-xl bg-white/8" placeholder="New Password">
      <input id="forgot-confirm-password" type="password" class="w-full mb-3 px-4 py-2 rounded-xl bg-white/8" placeholder="Confirm Password">
      <p id="forgot-msg" class="text-sm text-rose-300"></p>
      <button id="forgot-btn" class="w-full py-2 rounded-xl bg-indigo-500 text-white font-semibold" disabled>Reset Password</button>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast" class="fixed bottom-6 right-6 hidden"></div>

  <!-- Script (keeps similar backend behavior) -->
  <script>
    // Backend config
    const backendURL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://127.0.0.1:8000' : 'https://weapp2.onrender.com';
    let jwtToken = localStorage.getItem('jwtToken') || null;
    let recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

    // UI utilities
    function showToast(msg, success = true){
      const t = document.getElementById('toast');
      t.innerHTML = `<div class="px-4 py-2 rounded-lg ${success? 'bg-emerald-400 text-black' : 'bg-rose-500'} shadow">${msg}</div>`;
      t.classList.remove('hidden');
      setTimeout(()=> t.classList.add('hidden'), 3000);
    }

    function showApp(){
      document.getElementById('login-section').style.display='none';
      document.querySelector('main').classList.add('md:grid-cols-3');
    }
    function showLogin(){
      document.getElementById('login-section').style.display='block';
    }

    // Auth flows (kept simple)
    async function login(){
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const msg = document.getElementById('login-message'); msg.textContent='';
      if(!username || !password){ msg.textContent='Enter username & password.'; return; }
      try{
        const res = await fetch(`${backendURL}/token`, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:`username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}` });
        const data = await res.json();
        if(res.ok && data.access_token){ jwtToken = data.access_token; localStorage.setItem('jwtToken', jwtToken); showToast('Welcome back!'); showApp(); renderLists(); }
        else { msg.textContent = data.detail || 'Login failed'; }
      }catch(e){ msg.textContent = 'Network error'; }
    }

    async function register(){
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value.trim();
      const msg = document.getElementById('register-message'); msg.textContent='';
      if(!username || !password){ msg.textContent='Complete fields'; return; }
      try{
        const res = await fetch(`${backendURL}/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,password}) });
        if(res.ok){ showToast('Account created'); closeRegisterModal(); }
        else { const d=await res.json(); msg.textContent=d.detail||'Registration failed'; }
      }catch(e){ msg.textContent='Network error'; }
    }

    function logout(){ jwtToken=null; localStorage.removeItem('jwtToken'); showLogin(); showToast('Logged out', true); }

    // Modal helpers
    function showRegisterModal(){ document.getElementById('register-modal').classList.remove('hidden'); }
    function closeRegisterModal(){ document.getElementById('register-modal').classList.add('hidden'); }
    function showForgotPasswordModal(){ document.getElementById('forgot-modal').classList.remove('hidden'); }
    function closeForgotModal(){ document.getElementById('forgot-modal').classList.add('hidden'); }

    // Forgot password logic (local buttons wired)
    (function wireForgot(){
      const newInput = document.getElementById('forgot-new-password');
      const confirmInput = document.getElementById('forgot-confirm-password');
      const btn = document.getElementById('forgot-btn');
      const msg = document.getElementById('forgot-msg');
      if(newInput && confirmInput){
        function validate(){
          const a=newInput.value, b=confirmInput.value;
          if(!a||a.length<6){ msg.textContent='Password min 6 chars'; btn.disabled=true; return; }
          if(a!==b){ msg.textContent='Passwords do not match'; btn.disabled=true; return; }
          msg.textContent=''; btn.disabled=false;
        }
        newInput.addEventListener('input', validate); confirmInput.addEventListener('input', validate);
        btn.addEventListener('click', async ()=>{
          btn.disabled=true; btn.textContent='Resetting...';
          const username = document.getElementById('forgot-username').value.trim();
          try{ const res=await fetch(`${backendURL}/forgot-password`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,new_password:newInput.value}) }); if(res.ok){ showToast('Password reset'); closeForgotModal(); } else { const d=await res.json(); msg.textContent=d.detail||'Failed'; } }
          catch(e){ msg.textContent='Network error'; }
          btn.disabled=false; btn.textContent='Reset Password';
        });
      }
    })();

    // Weather functions
    function normalizeCityName(city){ if(!city) return ''; city=city.trim().toLowerCase(); return city.charAt(0).toUpperCase()+city.slice(1); }

    async function getWeather(city=null){
      const weatherDiv = document.getElementById('weather');
      if(!city) city = document.getElementById('cityInput').value.trim();
      city = normalizeCityName(city);
      if(!jwtToken){ weatherDiv.innerHTML='<p class="text-rose-300">Please log in to use the app.</p>'; return; }
      if(!city){ weatherDiv.innerHTML='<p class="text-rose-300">Enter a city name.</p>'; return; }
      weatherDiv.innerHTML='<div class="animate-pulse text-sm text-sky-100/80">Fetching weather...</div>';
      try{
        const res = await fetch(`${backendURL}/weather?city=${encodeURIComponent(city)}`, { headers:{ Authorization:`Bearer ${jwtToken}` } });
        if(res.status===401){ weatherDiv.innerHTML='<p class="text-rose-300">Session expired. Please sign in.</p>'; logout(); return; }
        const data = await res.json(); if(!res.ok){ weatherDiv.innerHTML=`<p class="text-rose-300">${data.detail||'Error'}</p>`; return; }
        updateDynamicBackground(data.condition);
        renderWeatherCard(data);
        updateRecentSearches(city);
        renderLists();
      }catch(e){ weatherDiv.innerHTML=`<p class="text-rose-300">Network error: ${e.message}</p>`; }
    }

    async function getForecast(city){ try{ const res=await fetch(`${backendURL}/forecast?city=${encodeURIComponent(city)}`, { headers:{ Authorization:`Bearer ${jwtToken}` } }); if(!res.ok){ return ['Forecast unavailable']; } const d=await res.json(); return d.forecast||[]; }catch(e){ return ['Error']; } }

    function renderWeatherCard(data){ const weatherDiv=document.getElementById('weather');
      const temp = data.temperature || '‚Äî';
      const cond = data.condition || '‚Äî';
      const html = `
        <div class="w-full flex flex-col md:flex-row gap-6">
          <div class="flex-1 bg-white/6 rounded-2xl p-6">
            <div class="flex items-center gap-4">
              <div class="text-6xl">‚òÄÔ∏è</div>
              <div>
                <h2 class="text-3xl font-bold">${data.city}</h2>
                <p class="text-sm text-sky-100/80">${data.date} ‚Ä¢ ${data.time}</p>
              </div>
            </div>
            <div class="mt-6 grid grid-cols-2 gap-3">
              <div><div class="text-sm text-sky-100/80">Temp</div><div class="text-xl font-bold">${temp}</div></div>
              <div><div class="text-sm text-sky-100/80">Condition</div><div class="text-xl font-bold">${cond}</div></div>
              <div><div class="text-sm text-sky-100/80">Wind</div><div class="text-xl font-bold">${data.wind}</div></div>
              <div><div class="text-sm text-sky-100/80">Humidity</div><div class="text-xl font-bold">${data.humidity}</div></div>
            </div>
            <div class="mt-6 flex gap-3">
              <button onclick="addFavorite('${data.city}')" class="px-4 py-2 rounded-xl bg-yellow-400 text-black">Add Favorite</button>
              <button onclick="getForecastAndShow('${data.city}')" class="px-4 py-2 rounded-xl bg-white/10">Show Forecast</button>
            </div>
          </div>
          <div id="forecastPanel" class="w-full md:w-96 bg-white/6 rounded-2xl p-4 overflow-auto">Loading forecast...</div>
        </div>
      `;
      weatherDiv.innerHTML = html;
      getForecastAndShow(data.city);
    }

    async function getForecastAndShow(city){ const f = await getForecast(city); const panel = document.getElementById('forecastPanel'); if(!panel) return; if(!Array.isArray(f)){ panel.innerHTML='<p class="text-sm">Forecast not available</p>'; return; } let html = '<h4 class="font-semibold mb-2">7-day forecast</h4><div class="space-y-2">'; f.forEach(day=>{ html+=`<div class="p-2 bg-white/4 rounded-lg"><div class="text-sm">${day.date}</div><div class="text-sm">${day.condition} ‚Ä¢ ${day.temperature}</div></div>`; }); html+='</div>'; panel.innerHTML = html; }

    function updateRecentSearches(city){ if(!recentSearches.includes(city)){ recentSearches.unshift(city); if(recentSearches.length>6) recentSearches.pop(); localStorage.setItem('recentSearches', JSON.stringify(recentSearches)); } }

    function renderLists(){ const r=document.getElementById('recentList'); const fav=document.getElementById('favoritesList'); r.innerHTML = recentSearches.length ? recentSearches.map(c=>`<li class="flex justify-between items-center"><span>${c}</span><div><button onclick="getWeather('${c}')" class="text-sm underline mr-2">View</button><button onclick="removeRecent('${c}')" class="text-sm text-rose-300">Remove</button></div></li>`).join('') : '<li class="text-sky-100/60">No recent searches</li>';
      fav.innerHTML = favorites.length ? favorites.map(c=>`<li class="flex justify-between items-center"><span>${c}</span><div><button onclick="getWeather('${c}')" class="text-sm underline mr-2">View</button><button onclick="removeFavorite('${c}')" class="text-sm text-rose-300">Remove</button></div></li>`).join('') : '<li class="text-sky-100/60">No favorites yet</li>';
    }

    function addFavorite(city){ if(!favorites.includes(city)){ favorites.push(city); localStorage.setItem('favorites', JSON.stringify(favorites)); showToast('Added to favorites'); renderLists(); } }
    function removeFavorite(city){ favorites = favorites.filter(c=>c!==city); localStorage.setItem('favorites', JSON.stringify(favorites)); renderLists(); }
    function removeRecent(city){ recentSearches = recentSearches.filter(c=>c!==city); localStorage.setItem('recentSearches', JSON.stringify(recentSearches)); renderLists(); }

    // geolocation
    async function geolocation(){ if(!jwtToken){ showToast('Please login first', false); return; } if(!navigator.geolocation){ showToast('Geolocation not supported', false); return; }
      try{ navigator.geolocation.getCurrentPosition(async (pos)=>{ const {latitude, longitude} = pos.coords; const res = await fetch(`${backendURL}/weather-by-coords?lat=${latitude}&lon=${longitude}`, { headers:{ Authorization:`Bearer ${jwtToken}` } }); const data = await res.json(); if(!res.ok){ showToast(data.detail||'Cannot fetch weather', false); return; } renderWeatherCard(data); updateRecentSearches(data.city); renderLists(); }, err=>{ showToast(err.message, false); }); }catch(e){ showToast('Error fetching location', false); } }

    // Dynamic background
    function updateDynamicBackground(condition){ const body = document.body; body.className='min-h-screen bg-gradient-to-br text-slate-100 antialiased'; const lower = (condition||'').toLowerCase(); if(lower.includes('rain')) body.classList.add('from-sky-500','to-gray-700'); else if(lower.includes('cloud')) body.classList.add('from-slate-500','to-indigo-700'); else if(lower.includes('clear')||lower.includes('sun')) body.classList.add('from-yellow-400','to-orange-500'); else if(lower.includes('storm')||lower.includes('thunder')) body.classList.add('from-gray-700','to-black'); else body.classList.add('from-sky-600','to-indigo-700'); }

    // Theme toggle (light/dark simulated)
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      document.documentElement.classList.toggle('light');
      document.body.classList.toggle('text-slate-900');
      document.body.classList.toggle('bg-white');
      showToast('Theme toggled');
    });

    // Initial wire up
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('login-btn').addEventListener('click', login);
      document.getElementById('register-btn').addEventListener('click', register);
      renderLists();
      if(localStorage.getItem('jwtToken')){ jwtToken = localStorage.getItem('jwtToken'); showApp(); }
    });
  </script>
</body>
</html>
